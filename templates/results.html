{% extends "base.html" %}

{% block title %}Analysis Results - Airline Market Analyzer{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h1>
                    <i class="fas fa-chart-bar"></i> Analysis Results
                </h1>
                <p class="lead mb-0">
                    Route: <strong>{{ search_params.origin }} â†’ {{ search_params.destination }}</strong> | 
                    Period: {{ search_params.date_from }} to {{ search_params.date_to }}
                </p>
            </div>
            <div>
                <a href="{{ url_for('search') }}" class="btn btn-secondary">
                    <i class="fas fa-arrow-left"></i> New Search
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Summary Cards -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card bg-primary text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 class="card-title">{{ data.total_flights or 0 }}</h4>
                        <p class="card-text">Total Flights</p>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-plane fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card bg-success text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 class="card-title">${{ "%.0f"|format(data.analysis.summary.price_range.avg or 0) }}</h4>
                        <p class="card-text">Average Price</p>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-dollar-sign fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card bg-info text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 class="card-title">${{ "%.0f"|format(data.analysis.summary.price_range.min or 0) }}</h4>
                        <p class="card-text">Lowest Price</p>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-arrow-down fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card bg-warning text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 class="card-title">${{ "%.0f"|format(data.analysis.summary.price_range.max or 0) }}</h4>
                        <p class="card-text">Highest Price</p>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-arrow-up fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- AI Insights -->
{% if insights %}
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-brain"></i> AI-Powered Market Insights
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6><i class="fas fa-chart-line"></i> Demand Trends</h6>
                        <p>{{ insights.demand_trends or "Analysis in progress..." }}</p>
                        
                        <h6><i class="fas fa-dollar-sign"></i> Pricing Insights</h6>
                        <p>{{ insights.pricing_insights or "Pricing analysis available..." }}</p>
                    </div>
                    <div class="col-md-6">
                        <h6><i class="fas fa-route"></i> Route Recommendations</h6>
                        <p>{{ insights.route_recommendations or "Route analysis completed..." }}</p>
                        
                        <h6><i class="fas fa-business-time"></i> Business Recommendations</h6>
                        <p>{{ insights.business_recommendations or "Business insights generated..." }}</p>
                    </div>
                </div>
                {% if insights.market_outlook %}
                <div class="alert alert-info mt-3">
                    <h6><i class="fas fa-crystal-ball"></i> Market Outlook</h6>
                    <p class="mb-0">{{ insights.market_outlook }}</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Charts Section -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-chart-line"></i> Price Trends
                </h5>
            </div>
            <div class="card-body">
                {% if charts and charts.price_trends %}
                    <div id="priceTrendsChart"></div>
                {% else %}
                    <div class="text-center py-4">
                        <i class="fas fa-chart-line fa-3x text-muted"></i>
                        <p class="mt-2 text-muted">Price trend data will appear here</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-chart-bar"></i> Weekly Patterns
                </h5>
            </div>
            <div class="card-body">
                {% if charts and charts.weekly_patterns %}
                    <div id="weeklyPatternsChart"></div>
                {% else %}
                    <div class="text-center py-4">
                        <i class="fas fa-chart-bar fa-3x text-muted"></i>
                        <p class="mt-2 text-muted">Weekly pattern data will appear here</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-chart-pie"></i> Price Distribution
                </h5>
            </div>
            <div class="card-body">
                {% if charts and charts.price_distribution %}
                    <div id="priceDistributionChart"></div>
                {% else %}
                    <div class="text-center py-4">
                        <i class="fas fa-chart-pie fa-3x text-muted"></i>
                        <p class="mt-2 text-muted">Price distribution will appear here</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-chart-area"></i> Daily Volume
                </h5>
            </div>
            <div class="card-body">
                {% if charts and charts.daily_volume %}
                    <div id="dailyVolumeChart"></div>
                {% else %}
                    <div class="text-center py-4">
                        <i class="fas fa-chart-area fa-3x text-muted"></i>
                        <p class="mt-2 text-muted">Daily volume data will appear here</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Detailed Analysis -->
<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-table"></i> Flight Data Summary
                </h5>
            </div>
            <div class="card-body">
                {% if data.flights_data %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Time</th>
                                <th>Airline</th>
                                <th>Price</th>
                                <th>Direct</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for flight in data.flights_data[:10] %}
                            <tr>
                                <td>{{ flight.date }}</td>
                                <td>{{ flight.time or "N/A" }}</td>
                                <td>{{ flight.airline or "N/A" }}</td>
                                <td>${{ "%.0f"|format(flight.price) }}</td>
                                <td>
                                    {% if flight.direct %}
                                        <span class="badge bg-success">Direct</span>
                                    {% else %}
                                        <span class="badge bg-warning">Connecting</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% if data.flights_data|length > 10 %}
                <p class="text-muted">Showing first 10 of {{ data.flights_data|length }} flights</p>
                {% endif %}
                {% else %}
                <div class="text-center py-4">
                    <i class="fas fa-plane fa-3x text-muted"></i>
                    <p class="mt-2 text-muted">No flight data available for this search</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-info-circle"></i> Quick Stats
                </h5>
            </div>
            <div class="card-body">
                {% if data.analysis %}
                <ul class="list-unstyled">
                    <li class="mb-2">
                        <strong>Price Range:</strong><br>
                        ${{ "%.0f"|format(data.analysis.summary.price_range.min or 0) }} - 
                        ${{ "%.0f"|format(data.analysis.summary.price_range.max or 0) }}
                    </li>
                    <li class="mb-2">
                        <strong>Median Price:</strong><br>
                        ${{ "%.0f"|format(data.analysis.summary.price_range.median or 0) }}
                    </li>
                    <li class="mb-2">
                        <strong>Date Range:</strong><br>
                        {{ data.analysis.summary.date_range.start or "N/A" }} to<br>
                        {{ data.analysis.summary.date_range.end or "N/A" }}
                    </li>
                    <li class="mb-2">
                        <strong>Airlines:</strong><br>
                        {{ data.analysis.summary.airlines or 0 }} different carriers
                    </li>
                </ul>
                {% endif %}
                
                <div class="d-grid gap-2 mt-3">
                    <a href="{{ url_for('api_data') }}" class="btn btn-outline-primary btn-sm">
                        <i class="fas fa-download"></i> Export Data
                    </a>
                    <button class="btn btn-outline-secondary btn-sm" onclick="window.print()">
                        <i class="fas fa-print"></i> Print Report
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Render charts if data is available
        {% if charts %}
            {% if charts.price_trends %}
                var priceTrendsData = {{ charts.price_trends|safe }};
                if (window.Plotly) Plotly.newPlot('priceTrendsChart', priceTrendsData.data, priceTrendsData.layout, {responsive: true});
            {% endif %}

            {% if charts.weekly_patterns %}
                var weeklyPatternsData = {{ charts.weekly_patterns|safe }};
                if (window.Plotly) Plotly.newPlot('weeklyPatternsChart', weeklyPatternsData.data, weeklyPatternsData.layout, {responsive: true});
            {% endif %}

            {% if charts.price_distribution %}
                var priceDistributionData = {{ charts.price_distribution|safe }};
                if (window.Plotly) Plotly.newPlot('priceDistributionChart', priceDistributionData.data, priceDistributionData.layout, {responsive: true});
            {% endif %}

            {% if charts.daily_volume %}
                var dailyVolumeData = {{ charts.daily_volume|safe }};
                if (window.Plotly) Plotly.newPlot('dailyVolumeChart', dailyVolumeData.data, dailyVolumeData.layout, {responsive: true});
            {% endif %}
        {% endif %}
    });
</script>
{% endblock %}
